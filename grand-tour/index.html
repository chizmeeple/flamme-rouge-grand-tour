<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flamme Rouge Grand Tour</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback } = React;

      // Main App Component
      function App() {
        // State management
        const [loading, setLoading] = useState(true);
        const [view, setView] = useState('setup');
        const [teams, setTeams] = useState([]);
        const [totalStages, setTotalStages] = useState(3);
        const [currentStage, setCurrentStage] = useState(1);
        const [finishedRiders, setFinishedRiders] = useState([]);
        const [showModal, setShowModal] = useState(false);
        const [modalRider, setModalRider] = useState(null);
        const [modalFinishPosition, setModalFinishPosition] = useState({
          row: 5,
          col: 1,
        });
        const [modalTokens, setModalTokens] = useState({
          sprint: 0,
          mountain: 0,
        });
        const [modalExhaustionCards, setModalExhaustionCards] = useState(0);
        const [error, setError] = useState(null);
        const [rankings, setRankings] = useState(null);
        const [editingTeamId, setEditingTeamId] = useState(null);
        const [addedTime, setAddedTime] = useState(0);
        const [roundNumber, setRoundNumber] = useState(1);
        const [isProcessingRound, setIsProcessingRound] = useState(false);
        const [showConfirmModal, setShowConfirmModal] = useState(false);
        const [showRulesModal, setShowRulesModal] = useState(false);
        const [finishType, setFinishType] = useState('flatland');
        const [showResetConfirmModal, setShowResetConfirmModal] =
          useState(false);

        // Load data from localStorage on initial render
        useEffect(() => {
          try {
            const savedData = JSON.parse(
              localStorage.getItem('flammeRougeTour')
            );
            if (savedData) {
              // Migrate old finishRow format to new grid format if needed
              let migratedFinishedRiders = savedData.finishedRiders || [];
              if (
                migratedFinishedRiders.length > 0 &&
                typeof migratedFinishedRiders[0].finishRow === 'number'
              ) {
                migratedFinishedRiders = migratedFinishedRiders.map(
                  (rider) => ({
                    ...rider,
                    finishRow: { row: rider.finishRow, col: 1 },
                  })
                );
              }

              setTeams(savedData.teams);
              setTotalStages(savedData.totalStages);
              setCurrentStage(savedData.currentStage);
              setFinishedRiders(migratedFinishedRiders);
              setView(savedData.view);
              setRankings(savedData.rankings);
              setAddedTime(savedData.addedTime || 0);
              setRoundNumber(savedData.roundNumber || 1);
              setFinishType(savedData.finishType || 'flatland');
              setLoading(false);
            } else {
              setTeams([
                {
                  id: 'red',
                  name: 'Red Team',
                  originalName: 'Red Team',
                  active: true,
                  history: [],
                },
                {
                  id: 'blue',
                  name: 'Blue Team',
                  originalName: 'Blue Team',
                  active: true,
                  history: [],
                },
                {
                  id: 'green',
                  name: 'Green Team',
                  originalName: 'Green Team',
                  active: true,
                  history: [],
                },
                {
                  id: 'black',
                  name: 'Black Team',
                  originalName: 'Black Team',
                  active: true,
                  history: [],
                },
                {
                  id: 'white',
                  name: 'White Team',
                  originalName: 'White Team',
                  active: true,
                  history: [],
                },
                {
                  id: 'pink',
                  name: 'Pink Team',
                  originalName: 'Pink Team',
                  active: true,
                  history: [],
                },
              ]);
              setTotalStages(3);
              setCurrentStage(1);
              setFinishedRiders([]);
              setView('setup');
              setRankings(null);
              setAddedTime(0);
              setRoundNumber(1);
              setFinishType('flatland');
              setLoading(false);
            }
          } catch (e) {
            console.error('Failed to load data from localStorage', e);
            setError('Failed to load tour data. Please try again.');
            setLoading(false);
          }
        }, []);

        // Save data to localStorage whenever state changes
        useEffect(() => {
          if (!loading) {
            const dataToSave = {
              teams,
              totalStages,
              currentStage,
              finishedRiders,
              view,
              rankings,
              addedTime,
              roundNumber,
              finishType,
            };
            localStorage.setItem('flammeRougeTour', JSON.stringify(dataToSave));
          }
        }, [
          loading,
          teams,
          totalStages,
          currentStage,
          finishedRiders,
          view,
          rankings,
          addedTime,
          roundNumber,
          finishType,
        ]);

        // Helper function to get team color classes
        const getTeamColorClasses = (originalName) => {
          switch (originalName) {
            case 'Red Team':
              return {
                bg: 'bg-red-600',
                text: 'text-white',
                hover: 'hover:bg-red-700',
              };
            case 'Blue Team':
              return {
                bg: 'bg-blue-600',
                text: 'text-white',
                hover: 'hover:bg-blue-700',
              };
            case 'Green Team':
              return {
                bg: 'bg-green-600',
                text: 'text-white',
                hover: 'hover:bg-green-700',
              };
            case 'Black Team':
              return {
                bg: 'bg-gray-800',
                text: 'text-white',
                hover: 'hover:bg-gray-900',
              };
            case 'White Team':
              return {
                bg: 'bg-gray-200',
                text: 'text-gray-900',
                hover: 'hover:bg-gray-300',
              };
            case 'Pink Team':
              return {
                bg: 'bg-pink-600',
                text: 'text-white',
                hover: 'hover:bg-pink-700',
              };
            default:
              return {
                bg: 'bg-gray-500',
                text: 'text-white',
                hover: 'hover:bg-gray-600',
              };
          }
        };

        // Logic for the Setup view
        const toggleTeam = (teamId) => {
          setTeams((prevTeams) =>
            prevTeams.map((team) =>
              team.id === teamId ? { ...team, active: !team.active } : team
            )
          );
        };

        const handleTeamNameChange = (e, teamId) => {
          const newName = e.target.value;
          setTeams((prevTeams) =>
            prevTeams.map((team) =>
              team.id === teamId ? { ...team, name: newName } : team
            )
          );
        };

        const handleSaveName = () => {
          setEditingTeamId(null);
        };

        const handleStartTour = () => {
          const activeTeams = teams.filter((t) => t.active);
          if (activeTeams.length === 0) {
            setError('Please select at least one team to start the tour.');
            return;
          }
          const initialTeams = activeTeams.map((team) => ({
            ...team,
            history: [],
          }));

          setTeams(initialTeams);
          setCurrentStage(1);
          setFinishedRiders([]);
          setView('stage');
          setError(null);
        };

        // Logic for the Stage view
        const openModal = (teamName, riderType) => {
          setModalRider({ teamName, riderType });
          setModalFinishPosition({
            row: finishType === 'flatland' ? 5 : 4,
            col: 1,
          });
          setModalTokens({ sprint: 0, mountain: 0 });
          setModalExhaustionCards(0);
          setShowModal(true);
        };

        const isFinishPositionOccupied = (row, col) => {
          return finishedRiders.some(
            (rider) =>
              rider.finishRow.row === row &&
              rider.finishRow.col === col &&
              rider.round === roundNumber
          );
        };

        const closeModal = () => {
          setShowModal(false);
          setModalRider(null);
        };

        const handleSubmitFinish = () => {
          if (!modalRider) return;

          const { teamName, riderType } = modalRider;
          const newFinishedRider = {
            teamName,
            riderType,
            time: null,
            podium: 0,
            sprint: modalTokens.sprint,
            mountain: modalTokens.mountain,
            round: roundNumber,
            finishRow: modalFinishPosition,
            exhaustionCards: modalExhaustionCards,
          };

          setFinishedRiders((prev) => [...prev, newFinishedRider]);
          closeModal();
        };

        const handleNextRound = () => {
          if (isProcessingRound) return;
          setIsProcessingRound(true);

          const secondsMap = {
            flatland: { 5: 0, 4: 10, 3: 20, 2: 30, 1: 40 },
            ascent: { 4: 0, 3: 10, 2: 20, 1: 30 },
          };
          const ridersInCurrentRound = finishedRiders
            .filter((r) => r.round === roundNumber && r.time === null)
            .sort((a, b) => {
              // Sort by row first (higher row = closer to finish line)
              if (a.finishRow.row !== b.finishRow.row) {
                return b.finishRow.row - a.finishRow.row;
              }
              // If same row, sort by column (left to right)
              return a.finishRow.col - b.finishRow.col;
            });

          const updatedFinished = [...finishedRiders];

          let packs = [];
          if (ridersInCurrentRound.length > 0) {
            let currentPack = [ridersInCurrentRound[0]];
            for (let i = 1; i < ridersInCurrentRound.length; i++) {
              if (
                ridersInCurrentRound[i].finishRow.row ===
                  ridersInCurrentRound[i - 1].finishRow.row ||
                ridersInCurrentRound[i].finishRow.row ===
                  ridersInCurrentRound[i - 1].finishRow.row - 1
              ) {
                currentPack.push(ridersInCurrentRound[i]);
              } else {
                packs.push(currentPack);
                currentPack = [ridersInCurrentRound[i]];
              }
            }
            packs.push(currentPack);
          }

          packs.forEach((pack) => {
            if (pack.length > 0) {
              const fastestFinishRow = pack.reduce(
                (max, r) => Math.max(max, r.finishRow.row),
                0
              );
              const secondsForPack = secondsMap[finishType][fastestFinishRow];
              const timeForPack = addedTime * 60 + secondsForPack;

              pack.forEach((riderToUpdate) => {
                const index = updatedFinished.findIndex(
                  (r) =>
                    r.teamName === riderToUpdate.teamName &&
                    r.riderType === riderToUpdate.riderType &&
                    r.round === riderToUpdate.round &&
                    r.time === null
                );
                if (index !== -1) {
                  updatedFinished[index] = {
                    ...updatedFinished[index],
                    time: timeForPack,
                  };
                }
              });
            }
          });

          setFinishedRiders(updatedFinished);
          setAddedTime((prev) => prev + 1);
          setRoundNumber((prev) => prev + 1);
          setIsProcessingRound(false);
          setShowConfirmModal(false);
        };

        const handleNextStage = () => {
          setLoading(true);

          const sortedFinishedRiders = [...finishedRiders].sort(
            (a, b) => a.time - b.time
          );

          const updatedFinishedRiders = sortedFinishedRiders.map(
            (rider, index) => {
              let podiumPoints = 0;
              if (index === 0) podiumPoints = 3;
              else if (index === 1) podiumPoints = 2;
              else if (index === 2) podiumPoints = 1;

              // Between stages, each rider returns half of their unplayed Exhaustion cards (rounded down)
              // Note: played Exhaustion cards were already returned during the stage
              const exhaustionCardsToReturn = Math.floor(
                (rider.exhaustionCards || 0) / 2
              );
              const remainingExhaustionCards =
                (rider.exhaustionCards || 0) - exhaustionCardsToReturn;

              return {
                ...rider,
                podium: podiumPoints,
                exhaustionCards: remainingExhaustionCards,
                exhaustionCardsReturned: exhaustionCardsToReturn,
              };
            }
          );

          const newTeams = teams.map((team) => {
            const updatedTeam = { ...team };
            const stageResults = {
              rouleur: updatedFinishedRiders.find(
                (r) => r.teamName === team.name && r.riderType === 'Rouleur'
              ),
              sprinteur: updatedFinishedRiders.find(
                (r) => r.teamName === team.name && r.riderType === 'Sprinteur'
              ),
            };

            updatedTeam.history.push({
              stage: currentStage,
              results: stageResults,
            });
            return updatedTeam;
          });

          const newCurrentStage = currentStage + 1;
          if (newCurrentStage > totalStages) {
            calculateFinalRankings(newTeams);
            setTeams(newTeams);
            setCurrentStage(newCurrentStage);
            setFinishedRiders([]);
            setView('rankings');
          } else {
            setTeams(newTeams);
            setCurrentStage(newCurrentStage);
            setFinishedRiders([]);
            setAddedTime(0);
            setRoundNumber(1);
          }
          setLoading(false);
        };

        const calculateFinalRankings = (tourTeams) => {
          const calculateTotals = (team) => {
            const totals = { time: 0, podium: 0, sprint: 0, mountain: 0 };
            team.history.forEach((stage) => {
              const rouleurTime = stage.results.rouleur
                ? stage.results.rouleur.time
                : 0;
              const sprinteurTime = stage.results.sprinteur
                ? stage.results.sprinteur.time
                : 0;
              totals.time += rouleurTime + sprinteurTime;
              const rouleurPodium = stage.results.rouleur
                ? stage.results.rouleur.podium
                : 0;
              const sprinteurPodium = stage.results.sprinteur
                ? stage.results.sprinteur.podium
                : 0;
              totals.podium += rouleurPodium + sprinteurPodium;
              const rouleurSprint = stage.results.rouleur
                ? stage.results.rouleur.sprint
                : 0;
              const sprinteurSprint = stage.results.sprinteur
                ? stage.results.sprinteur.sprint
                : 0;
              totals.sprint += rouleurSprint + sprinteurSprint;
              const rouleurMountain = stage.results.rouleur
                ? stage.results.rouleur.mountain
                : 0;
              const sprinteurMountain = stage.results.sprinteur
                ? stage.results.sprinteur.mountain
                : 0;
              totals.mountain += rouleurMountain + sprinteurMountain;
            });
            return totals;
          };

          const teamTotals = tourTeams.map((team) => {
            const totals = calculateTotals(team);
            return { ...team, ...totals };
          });

          const gcRankings = teamTotals.sort((a, b) => a.time - b.time);
          const scRankings = teamTotals.sort((a, b) => b.sprint - a.sprint);
          const mcRankings = teamTotals.sort((a, b) => b.mountain - a.mountain);

          setRankings({
            gc: gcRankings,
            sc: scRankings,
            mc: mcRankings,
          });
        };

        const handleRestartTour = () => {
          localStorage.removeItem('flammeRougeTour');
          window.location.reload();
        };

        const formatTime = (seconds) => {
          if (seconds === null) return 'TBC';
          const min = Math.floor(seconds / 60);
          const sec = seconds % 60;
          return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        };

        const renderSetup = () => {
          const inactiveClasses = 'bg-gray-800';
          const inactiveTextClasses = 'text-gray-100';

          return (
            <div className="flex flex-col items-center p-4">
              <div className="w-full max-w-md flex items-center justify-between mb-4">
                <h2 className="text-2xl font-bold text-gray-100">
                  Set Up Grand Tour
                </h2>
                <div className="flex items-center space-x-2">
                  <button
                    onClick={() => setShowRulesModal(true)}
                    className="px-3 py-1 rounded-lg text-sm bg-gray-700 text-gray-100 hover:bg-gray-600 transition"
                  >
                    üìñ Rules
                  </button>
                  <button
                    onClick={() => setShowResetConfirmModal(true)}
                    className="px-3 py-1 rounded-lg text-sm bg-red-600 text-white hover:bg-red-700 transition"
                  >
                    Reset Tour
                  </button>
                </div>
              </div>
              <div className="w-full max-w-md">
                <h3 className="text-xl font-semibold mb-2 text-gray-300">
                  Select Teams
                </h3>
                <div className="flex flex-col space-y-2 mb-6">
                  {teams.map((team) => {
                    const color = getTeamColorClasses(team.originalName);
                    return (
                      <div
                        key={team.id}
                        className={`flex items-center justify-between p-3 rounded-xl shadow-sm transition-all duration-200 ${
                          team.active
                            ? `${color.bg} ${color.hover}`
                            : inactiveClasses
                        }`}
                      >
                        <div className="flex items-center space-x-2 w-full flex-1">
                          {editingTeamId === team.id ? (
                            <div className="flex items-center w-full space-x-2">
                              <input
                                type="text"
                                value={team.name}
                                onChange={(e) =>
                                  handleTeamNameChange(e, team.id)
                                }
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    handleSaveName();
                                  }
                                }}
                                onFocus={(e) => {
                                  if (team.name === team.originalName) {
                                    e.target.select();
                                  }
                                }}
                                placeholder="Enter team name"
                                autoFocus
                                className="w-full px-3 py-2 rounded-lg text-sm transition-all duration-200 bg-white text-gray-900 placeholder-gray-400"
                              />
                              <button
                                className="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition"
                                onClick={handleSaveName}
                              >
                                Save
                              </button>
                            </div>
                          ) : (
                            <span
                              className={`font-medium flex items-center ${
                                team.active ? color.text : inactiveTextClasses
                              }`}
                            >
                              <span>{team.name}</span>
                              {team.name !== team.originalName && (
                                <span
                                  className={`text-sm ml-2 ${
                                    team.active
                                      ? 'text-opacity-80'
                                      : 'text-gray-400'
                                  }`}
                                >
                                  ({team.originalName})
                                </span>
                              )}
                              <button
                                className={`transition duration-200 ml-2 ${
                                  team.active
                                    ? `${color.text} hover:text-opacity-60`
                                    : `${inactiveTextClasses} hover:text-gray-500`
                                }`}
                                onClick={() => setEditingTeamId(team.id)}
                              >
                                ‚úèÔ∏è
                              </button>
                            </span>
                          )}
                        </div>
                        <button
                          onClick={() => toggleTeam(team.id)}
                          className={`w-8 h-8 rounded-full border-2 transition-all duration-200 flex items-center justify-center cursor-pointer touch-manipulation ${
                            team.active
                              ? 'bg-white border-white shadow-sm'
                              : 'bg-transparent border-gray-400 hover:border-gray-300'
                          }`}
                          aria-label={`Toggle ${team.name} active status`}
                        >
                          {team.active && (
                            <div className="w-3 h-3 rounded-full bg-gray-800"></div>
                          )}
                        </button>
                      </div>
                    );
                  })}
                </div>
                <h3 className="text-xl font-semibold mb-2 text-gray-300">
                  Number of Stages
                </h3>
                <div className="flex items-center justify-center space-x-4 mb-6">
                  <button
                    className="p-2 rounded-full bg-gray-700 text-gray-300 hover:bg-gray-600 transition"
                    onClick={() =>
                      setTotalStages((prev) => Math.max(2, prev - 1))
                    }
                  >
                    ‚ñº
                  </button>
                  <span className="text-4xl font-bold text-gray-100">
                    {totalStages}
                  </span>
                  <button
                    className="p-2 rounded-full bg-gray-700 text-gray-300 hover:bg-gray-600 transition"
                    onClick={() =>
                      setTotalStages((prev) => Math.min(21, prev + 1))
                    }
                  >
                    ‚ñ≤
                  </button>
                </div>
                <h3 className="text-xl font-semibold mb-2 text-gray-300">
                  Finish Type
                </h3>
                <div className="flex justify-between space-x-4 mb-6">
                  <button
                    onClick={() => setFinishType('flatland')}
                    className={`flex-1 py-3 rounded-lg font-bold text-lg transition ${
                      finishType === 'flatland'
                        ? 'bg-indigo-600 text-white'
                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    }`}
                  >
                    Flatland
                  </button>
                  <button
                    onClick={() => setFinishType('ascent')}
                    className={`flex-1 py-3 rounded-lg font-bold text-lg transition ${
                      finishType === 'ascent'
                        ? 'bg-indigo-600 text-white'
                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    }`}
                  >
                    Ascent
                  </button>
                </div>
                {error && <p className="text-red-400 text-sm mb-4">{error}</p>}
                <button
                  className="w-full py-4 bg-indigo-600 text-white rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center space-x-2"
                  onClick={handleStartTour}
                  disabled={loading}
                >
                  <span className="font-bold">START THE TOUR</span>
                </button>
              </div>
            </div>
          );
        };

        const renderRiderAvatar = (teamName, riderType) => {
          const team = teams.find((t) => t.name === teamName);
          if (!team) return null;
          const { bg, text } = getTeamColorClasses(team.originalName);

          // Determine badge shape based on rider type
          const isRouleur = riderType === 'Rouleur';
          const badgeClasses = isRouleur
            ? 'rounded-full' // R badge remains circular
            : 'rounded-md'; // S badge becomes square with rounded corners

          return (
            <div className="relative w-10 h-10 rounded-full bg-gray-700 border-2 border-gray-600 flex items-center justify-center">
              <span className="text-2xl">üö¥</span>
              <div
                className={`absolute -top-1 -right-1 w-5 h-5 ${badgeClasses} flex items-center justify-center text-xs font-bold ${bg} ${text} border border-gray-900`}
              >
                {riderType.charAt(0)}
              </div>
            </div>
          );
        };

        const renderStage = () => {
          const remainingRiders = teams
            .flatMap((team) => [
              {
                type: 'Rouleur',
                teamName: team.name,
                originalName: team.originalName,
              },
              {
                type: 'Sprinteur',
                teamName: team.name,
                originalName: team.originalName,
              },
            ])
            .filter(
              (rider) =>
                !finishedRiders.some(
                  (fr) =>
                    fr.teamName === rider.teamName &&
                    fr.riderType === rider.type
                )
            );

          const rowsForFinishType =
            finishType === 'flatland' ? [5, 4, 3, 2, 1] : [4, 3, 2, 1];

          return (
            <div className="flex flex-col items-center p-4 min-h-screen">
              <div className="w-full max-w-md">
                <div className="flex items-center justify-between mb-6">
                  <button
                    onClick={() => setView('setup')}
                    className="text-gray-500 hover:text-gray-400 transition"
                  >
                    ‚Üê
                  </button>
                  <h2 className="text-3xl font-bold text-gray-100">
                    STAGE {currentStage} / {totalStages}
                  </h2>
                  <div className="flex items-center space-x-2">
                    <button
                      onClick={() => setShowRulesModal(true)}
                      className="px-3 py-1 rounded-lg text-sm bg-gray-700 text-gray-100 hover:bg-gray-600 transition"
                    >
                      üìñ Rules
                    </button>
                    <button
                      onClick={() => setView('rankings')}
                      className="text-gray-500 hover:text-gray-400 transition"
                    >
                      üèÜ
                    </button>
                  </div>
                </div>

                <div className="bg-gray-800 p-4 rounded-xl shadow-sm mb-6">
                  <h3 className="text-lg font-semibold text-gray-300 mb-2 flex items-center justify-between">
                    <span>Riders in Race - Round {roundNumber}</span>
                    {finishedRiders.some(
                      (r) => r.round === roundNumber && r.time === null
                    ) && (
                      <button
                        onClick={() => setShowConfirmModal(true)}
                        className="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-300"
                      >
                        {isProcessingRound ? '...' : 'Next Round'}
                      </button>
                    )}
                  </h3>
                  <ul className="space-y-2">
                    {remainingRiders.map((rider, index) => (
                      <li
                        key={`${rider.teamName}-${rider.type}`}
                        className="flex items-center justify-between bg-gray-700 text-gray-100 p-3 rounded-lg shadow-sm"
                      >
                        <div className="flex items-center space-x-4">
                          {renderRiderAvatar(rider.teamName, rider.type)}
                          <span className="font-medium">
                            {rider.teamName}
                            {rider.teamName !== rider.originalName && (
                              <span className="text-gray-400 text-sm">
                                {' '}
                                ({rider.originalName})
                              </span>
                            )}{' '}
                            {rider.type}
                          </span>
                        </div>
                        <button
                          className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-300"
                          onClick={() => openModal(rider.teamName, rider.type)}
                        >
                          FINISH
                        </button>
                      </li>
                    ))}
                  </ul>
                </div>

                {finishedRiders.length > 0 && (
                  <div className="bg-gray-800 p-4 rounded-xl shadow-sm">
                    <h3 className="text-lg font-semibold text-gray-300 mb-2">
                      Finished Riders
                    </h3>

                    {/* Finish Position Grid */}
                    <div className="mb-4 p-3 bg-gray-900 rounded-lg">
                      <h4 className="text-sm font-medium text-gray-300 mb-2 text-center">
                        Finish Positions
                      </h4>
                      <div className="flex justify-center">
                        <div className="bg-gray-800 p-2 rounded-lg relative">
                          {/* Double-line border on the right to indicate "slightly further forward" */}
                          <div className="absolute right-0 top-0 bottom-0 w-2 flex flex-col">
                            <div className="flex-1 border-r-2 border-white"></div>
                            <div className="w-1"></div>
                            <div className="flex-1 border-r-2 border-white"></div>
                          </div>
                          {rowsForFinishType.map((row) => (
                            <div key={row} className="flex space-x-1 mb-1">
                              {[1, 2, 3].map((col) => {
                                const rider = finishedRiders.find(
                                  (r) =>
                                    r.finishRow.row === row &&
                                    r.finishRow.col === col
                                );
                                return (
                                  <div
                                    key={`${row}-${col}`}
                                    className={`flex-1 h-12 rounded border-2 flex items-center justify-center text-xs font-bold relative ${
                                      rider
                                        ? 'border-indigo-400 bg-indigo-600 text-white'
                                        : 'border-gray-600 bg-gray-700 text-gray-400'
                                    }`}
                                    title={
                                      rider
                                        ? `${rider.teamName} ${rider.riderType}`
                                        : `Row ${row}, Col ${col}`
                                    }
                                  >
                                    {rider ? (
                                      <div className="text-center leading-tight">
                                        <div className="text-[8px]">
                                          {rider.teamName.split(' ')[0]}
                                        </div>
                                        <div className="text-[8px]">
                                          {rider.riderType.slice(0, 3)}
                                        </div>
                                      </div>
                                    ) : (
                                      `${row}-${col}`
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>

                    <ul className="space-y-2">
                      {finishedRiders
                        .sort(
                          (a, b) =>
                            (a.time === null) - (b.time === null) ||
                            a.time - b.time
                        )
                        .map((rider, index) => (
                          <li
                            key={`${rider.teamName}-${rider.riderType}`}
                            className="flex items-center justify-between bg-gray-700 text-gray-100 p-3 rounded-lg shadow-sm"
                          >
                            <div className="flex items-center space-x-4">
                              <span className="mr-2 text-indigo-400 font-bold">
                                #{index + 1}
                              </span>
                              {renderRiderAvatar(
                                rider.teamName,
                                rider.riderType
                              )}
                              <span className="font-medium">
                                {rider.teamName}{' '}
                                {teams.find((t) => t.name === rider.teamName)
                                  ?.name !==
                                  teams.find((t) => t.name === rider.teamName)
                                    ?.originalName && (
                                  <span className="text-gray-400 text-sm">
                                    (
                                    {
                                      teams.find(
                                        (t) => t.name === rider.teamName
                                      )?.originalName
                                    }
                                    )
                                  </span>
                                )}{' '}
                                {rider.riderType}
                              </span>
                            </div>
                            <span className="text-gray-400 text-sm">
                              Time: {formatTime(rider.time)}
                              <br />
                              <span className="text-xs">
                                Round: {rider.round}, Finish: Row{' '}
                                {rider.finishRow.row}, Col {rider.finishRow.col}
                                {rider.exhaustionCards !== undefined && (
                                  <>
                                    <br />
                                    Exhaustion: {rider.exhaustionCards} cards
                                  </>
                                )}
                              </span>
                            </span>
                          </li>
                        ))}
                    </ul>
                  </div>
                )}

                {remainingRiders.length === 0 && (
                  <button
                    className="mt-6 w-full py-4 bg-indigo-600 text-white rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center space-x-2"
                    onClick={handleNextStage}
                    disabled={loading}
                  >
                    {loading ? '...' : '‚Üí'}
                    <span className="font-bold">NEXT STAGE</span>
                  </button>
                )}
              </div>

              {showModal && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
                  <div className="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <div className="flex justify-end">
                      <button
                        onClick={closeModal}
                        className="text-gray-400 hover:text-gray-300"
                      >
                        X
                      </button>
                    </div>
                    <h3 className="text-xl font-bold mb-4 text-gray-100">
                      Score Rider
                    </h3>
                    <div className="flex items-center space-x-4 mb-4 justify-center">
                      {renderRiderAvatar(
                        modalRider.teamName,
                        modalRider.riderType
                      )}
                      <p className="text-lg font-medium text-gray-300">
                        {modalRider.teamName} {modalRider.riderType}
                      </p>
                    </div>

                    <div className="space-y-4">
                      <div className="flex flex-col">
                        <label className="font-semibold text-gray-300 mb-2">
                          Select finish position:
                        </label>
                        <div className="bg-gray-900 p-3 rounded-lg relative">
                          {/* Double-line border on the right to indicate "slightly further forward" */}
                          <div className="absolute right-0 top-0 bottom-0 w-2 flex flex-col">
                            <div className="flex-1 border-r-2 border-white"></div>
                            <div className="w-1"></div>
                            <div className="flex-1 border-r-2 border-white"></div>
                          </div>
                          {rowsForFinishType.map((row) => (
                            <div key={row} className="flex space-x-2 mb-2">
                              {[1, 2, 3].map((col) => {
                                const isOccupied = isFinishPositionOccupied(
                                  row,
                                  col
                                );
                                const isSelected =
                                  modalFinishPosition.row === row &&
                                  modalFinishPosition.col === col;
                                return (
                                  <button
                                    key={`${row}-${col}`}
                                    onClick={() =>
                                      !isOccupied &&
                                      setModalFinishPosition({ row, col })
                                    }
                                    disabled={isOccupied}
                                    className={`flex-1 h-12 rounded-lg font-bold text-sm transition relative ${
                                      isSelected
                                        ? 'bg-indigo-600 text-white'
                                        : isOccupied
                                        ? 'bg-red-600 text-white cursor-not-allowed'
                                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                    }`}
                                    title={
                                      isOccupied
                                        ? 'Position occupied'
                                        : `Row ${row}, Column ${col}`
                                    }
                                  >
                                    {isOccupied ? '‚úó' : `${row}-${col}`}
                                  </button>
                                );
                              })}
                            </div>
                          ))}
                        </div>
                        <div className="text-xs text-gray-400 text-center mt-2">
                          Select a specific finish position. Red squares are
                          occupied.
                        </div>
                      </div>

                      <div className="text-xs text-gray-400 text-center">
                        Between stages, riders return half of their unplayed
                        Exhaustion cards (rounded down)
                      </div>

                      <div className="flex items-center justify-between">
                        <label className="font-semibold text-gray-300">
                          Unplayed Exhaustion Cards
                        </label>
                        <input
                          type="number"
                          value={modalExhaustionCards}
                          onChange={(e) =>
                            setModalExhaustionCards(
                              Math.max(0, parseInt(e.target.value) || 0)
                            )
                          }
                          className="w-24 px-3 py-2 border rounded-lg text-center bg-gray-700 text-white border-gray-600"
                        />
                      </div>

                      <div className="text-xs text-gray-400 text-center">
                        When a rider enters into, or passes, a square that has a
                        Major or Minor token pile next to it, they take the most
                        valuable token from the pile and place it next to their
                        rider deck. If several riders reach or pass the same
                        token pile on the same round, whichever rider is
                        furthest ahead at the end of that round takes the most
                        valuable token, the second furthest takes the second
                        most valuable token, and so on.
                      </div>

                      <div className="flex items-center justify-between">
                        <label className="font-semibold text-gray-300">
                          Sprint Points
                        </label>
                        <input
                          type="number"
                          value={modalTokens.sprint}
                          onChange={(e) =>
                            setModalTokens({
                              ...modalTokens,
                              sprint: Math.max(
                                0,
                                parseInt(e.target.value) || 0
                              ),
                            })
                          }
                          className="w-24 px-3 py-2 border rounded-lg text-center bg-gray-700 text-white border-gray-600"
                        />
                      </div>

                      <div className="flex items-center justify-between">
                        <label className="font-semibold text-gray-300">
                          Mountain Points
                        </label>
                        <input
                          type="number"
                          value={modalTokens.mountain}
                          onChange={(e) =>
                            setModalTokens({
                              ...modalTokens,
                              mountain: Math.max(
                                0,
                                parseInt(e.target.value) || 0
                              ),
                            })
                          }
                          className="w-24 px-3 py-2 border rounded-lg text-center bg-gray-700 text-white border-gray-600"
                        />
                      </div>
                    </div>

                    <button
                      className="mt-6 w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-300"
                      onClick={handleSubmitFinish}
                    >
                      Confirm
                    </button>
                  </div>
                </div>
              )}

              {showConfirmModal && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
                  <div className="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
                    <h3 className="text-xl font-bold mb-4 text-gray-100">
                      Confirm End Of Round
                    </h3>
                    <p className="text-gray-300 mb-6">
                      Make sure that ALL riders have been logged for this round.
                      Starting a new round cannot be undone.
                    </p>
                    <div className="flex space-x-4">
                      <button
                        className="flex-1 py-3 rounded-lg bg-gray-700 text-gray-100 hover:bg-gray-600 transition"
                        onClick={() => setShowConfirmModal(false)}
                      >
                        Cancel
                      </button>
                      <button
                        className="flex-1 py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition"
                        onClick={handleNextRound}
                        disabled={isProcessingRound}
                      >
                        {isProcessingRound ? '...' : 'Confirm'}
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showRulesModal && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
                  <div className="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold text-gray-100">
                        Game Rules & Resources
                      </h3>
                      <button
                        onClick={() => setShowRulesModal(false)}
                        className="text-gray-400 hover:text-gray-300"
                      >
                        X
                      </button>
                    </div>
                    <ul className="space-y-4 text-left">
                      <li>
                        <a
                          href="https://cdn.1j1ju.com/medias/2c/50/2b-flamme-rouge-rulebook.pdf"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-indigo-400 hover:text-indigo-300 transition"
                        >
                          Base Game Rules
                        </a>
                      </li>
                      <li>
                        <a
                          href="https://cdn.1j1ju.com/medias/94/37/1a-flamme-rouge-peloton-rulebook.pdf"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-indigo-400 hover:text-indigo-300 transition"
                        >
                          Peloton Rules
                        </a>
                      </li>
                      <li>
                        <a
                          href="https://tesera.ru/images/items/1383121/Flamme_Rouge_Meteo_rules_for_internet_1.pdf"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-indigo-400 hover:text-indigo-300 transition"
                        >
                          Meteo Rules
                        </a>
                      </li>
                      <li>
                        <a
                          href="https://lautapelit.mycashflow.fi/files/Online%20rules/Flamme%20Grand%20Tour%20rulebook_280x280_ENG_2024-10-08_web.pdf"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-indigo-400 hover:text-indigo-300 transition"
                        >
                          Grand Tour Rules
                        </a>
                      </li>
                      <li>
                        <a
                          href="https://notebooklm.google.com/notebook/e278d56c-d5b8-40e5-aff6-9e7e786eb29d"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-indigo-400 hover:text-indigo-300 transition"
                        >
                          AI Rules Assistant
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const renderRankings = () => {
          if (!rankings) {
            return (
              <div className="flex flex-col items-center justify-center min-h-screen bg-gray-900 text-gray-100">
                <h2 className="text-2xl font-bold mb-4 text-gray-100">
                  Final Rankings
                </h2>
                <p className="text-gray-300">Calculating rankings...</p>
                <button
                  onClick={() => setView('stage')}
                  className="mt-4 px-4 py-2 rounded-lg bg-gray-700 text-gray-100 hover:bg-gray-600"
                >
                  Go Back
                </button>
              </div>
            );
          }
          const { gc, sc, mc } = rankings;
          return (
            <div className="flex flex-col items-center p-4 min-h-screen">
              <div className="w-full max-w-md">
                <div className="flex items-center justify-between mb-6">
                  <button
                    onClick={() => setView('stage')}
                    className="text-gray-500 hover:text-gray-400 transition"
                  >
                    ‚Üê
                  </button>
                  <h2 className="text-3xl font-bold text-gray-100">
                    Final Rankings
                  </h2>
                  <button
                    onClick={handleRestartTour}
                    className="text-gray-500 hover:text-gray-400 transition"
                  >
                    üîÑ
                  </button>
                </div>

                <div className="space-y-6">
                  {/* General Classification */}
                  <div className="bg-gray-800 p-4 rounded-xl shadow-sm">
                    <h3 className="text-xl font-bold mb-2 text-gray-300 flex items-center space-x-2">
                      <span>‚è±Ô∏è</span>
                      <span>General Classification (Total Time)</span>
                    </h3>
                    <ul className="space-y-2">
                      {gc.map((team, index) => (
                        <li
                          key={team.id}
                          className="flex items-center justify-between bg-gray-700 p-3 rounded-lg shadow-sm"
                        >
                          <div className="flex items-center space-x-4">
                            <span className="mr-2 text-indigo-400 font-bold">
                              #{index + 1}
                            </span>
                            <div className="flex items-center">
                              {renderRiderAvatar(team.name, 'Rouleur')}
                              <span className="font-medium ml-4 text-gray-100">
                                {team.name}{' '}
                                {team.name !== team.originalName && (
                                  <span className="text-gray-400 text-sm">
                                    ({team.originalName})
                                  </span>
                                )}
                              </span>
                            </div>
                          </div>
                          <span className="text-gray-400 text-sm">
                            {formatTime(team.time)}
                          </span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  {/* Sprint Classification */}
                  <div className="bg-gray-800 p-4 rounded-xl shadow-sm">
                    <h3 className="text-xl font-bold mb-2 text-gray-300 flex items-center space-x-2">
                      <span>üèÅ</span>
                      <span>Sprint Classification</span>
                    </h3>
                    <ul className="space-y-2">
                      {sc.map((team, index) => (
                        <li
                          key={team.id}
                          className="flex items-center justify-between bg-gray-700 p-3 rounded-lg shadow-sm"
                        >
                          <div className="flex items-center space-x-4">
                            <span className="mr-2 text-indigo-400 font-bold">
                              #{index + 1}
                            </span>
                            <div className="flex items-center">
                              {renderRiderAvatar(team.name, 'Sprinteur')}
                              <span className="font-medium ml-4 text-gray-100">
                                {team.name}{' '}
                                {team.name !== team.originalName && (
                                  <span className="text-gray-400 text-sm">
                                    ({team.originalName})
                                  </span>
                                )}
                              </span>
                            </div>
                          </div>
                          <span className="text-gray-400 text-sm">
                            {team.sprint} pts
                          </span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  {/* Mountain Classification */}
                  <div className="bg-gray-800 p-4 rounded-xl shadow-sm">
                    <h3 className="text-xl font-bold mb-2 text-gray-300 flex items-center space-x-2">
                      <span>ü•á</span>
                      <span>Mountain Classification</span>
                    </h3>
                    <ul className="space-y-2">
                      {mc.map((team, index) => (
                        <li
                          key={team.id}
                          className="flex items-center justify-between bg-gray-700 p-3 rounded-lg shadow-sm"
                        >
                          <div className="flex items-center space-x-4">
                            <span className="mr-2 text-indigo-400 font-bold">
                              #{index + 1}
                            </span>
                            <div className="flex items-center">
                              {renderRiderAvatar(team.name, 'Rouleur')}
                              <span className="font-medium ml-4 text-gray-100">
                                {team.name}{' '}
                                {team.name !== team.originalName && (
                                  <span className="text-gray-400 text-sm">
                                    ({team.originalName})
                                  </span>
                                )}
                              </span>
                            </div>
                          </div>
                          <span className="text-gray-400 text-sm">
                            {team.mountain} pts
                          </span>
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // Main render logic
        if (loading) {
          return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gray-900 text-gray-100">
              <p className="text-lg">Loading Tour...</p>
            </div>
          );
        }

        if (error) {
          return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gray-900 text-red-400 p-4 text-center">
              <p className="font-semibold text-lg">{error}</p>
              <button
                onClick={() => window.location.reload()}
                className="mt-4 px-4 py-2 rounded-lg bg-red-800 text-red-100"
              >
                Reload
              </button>
            </div>
          );
        }

        const currentView = {
          setup: renderSetup(),
          stage: renderStage(),
          rankings: renderRankings(),
        }[view];

        return (
          <div className="min-h-screen bg-gray-900 font-sans antialiased text-gray-100">
            {currentView}
            {showRulesModal && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
                <div className="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-bold text-gray-100">
                      Game Rules & Resources
                    </h3>
                    <button
                      onClick={() => setShowRulesModal(false)}
                      className="text-gray-400 hover:text-gray-300"
                    >
                      X
                    </button>
                  </div>
                  <ul className="space-y-4 text-left">
                    <li>
                      <a
                        href="https://cdn.1j1ju.com/medias/2c/50/2b-flamme-rouge-rulebook.pdf"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-indigo-400 hover:text-indigo-300 transition"
                      >
                        Base Game Rules
                      </a>
                    </li>
                    <li>
                      <a
                        href="https://cdn.1j1ju.com/medias/94/37/1a-flamme-rouge-peloton-rulebook.pdf"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-indigo-400 hover:text-indigo-300 transition"
                      >
                        Peloton Rules
                      </a>
                    </li>
                    <li>
                      <a
                        href="https://tesera.ru/images/items/1383121/Flamme_Rouge_Meteo_rules_for_internet_1.pdf"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-indigo-400 hover:text-indigo-300 transition"
                      >
                        Meteo Rules
                      </a>
                    </li>
                    <li>
                      <a
                        href="https://lautapelit.mycashflow.fi/files/Online%20rules/Flamme%20Grand%20Tour%20rulebook_280x280_ENG_2024-10-08_web.pdf"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-indigo-400 hover:text-indigo-300 transition"
                      >
                        Grand Tour Rules
                      </a>
                    </li>
                    <li>
                      <a
                        href="https://notebooklm.google.com/notebook/e278d56c-d5b8-40e5-aff6-9e7e786eb29d"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-indigo-400 hover:text-indigo-300 transition"
                      >
                        AI Rules Assistant
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            )}

            {showResetConfirmModal && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
                <div className="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
                  <h3 className="text-xl font-bold mb-4 text-gray-100">
                    Confirm Reset
                  </h3>
                  <p className="text-gray-300 mb-6">
                    Are you sure you want to reset the tour? All progress will
                    be lost.
                  </p>
                  <div className="flex space-x-4">
                    <button
                      className="flex-1 py-3 rounded-lg bg-gray-700 text-gray-100 hover:bg-gray-700 transition"
                      onClick={() => setShowResetConfirmModal(false)}
                    >
                      Cancel
                    </button>
                    <button
                      className="flex-1 py-3 rounded-lg bg-red-600 text-white hover:bg-red-700 transition"
                      onClick={handleRestartTour}
                    >
                      Confirm Reset
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // Use createRoot for React 18 compatibility
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
